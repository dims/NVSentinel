# PostgreSQL Provider for NVSentinel

The PostgreSQL provider enables NVSentinel to use PostgreSQL as its datastore instead of MongoDB. This provider implements all the same interfaces as the MongoDB provider while leveraging PostgreSQL's strengths, including robust certificate-based authentication.

## Features

- **Full Compatibility**: Implements all datastore interfaces with feature parity to MongoDB
- **JSON Storage**: Uses JSONB for flexible document storage with PostgreSQL optimizations
- **Change Streams**: Polling-based change stream implementation using triggers
- **Performance**: Optimized indexes for common query patterns
- **Transactions**: ACID compliance with proper transaction handling
- **Certificate Authentication**: TLS client certificate authentication with cert-manager integration
- **SSL Support**: Full SSL/TLS configuration support with automatic certificate management
- **Multi-Architecture**: Support for AMD64 and ARM64 architectures
- **CI/CD Integration**: Comprehensive E2E testing in CI/CD pipeline

## Configuration

### Certificate-Based Authentication (Recommended)

NVSentinel PostgreSQL provider uses certificate-based authentication by default, eliminating the need for passwords and providing enhanced security:

```yaml
# Kubernetes values configuration
global:
  datastore:
    provider: "postgresql"
    connection:
      host: "nvsentinel-postgresql.nvsentinel.svc.cluster.local"
      port: 5432
      database: "nvsentinel"
      username: "postgresql"  # Must match certificate CommonName
      sslmode: "require"
      sslcert: "/etc/ssl/client-certs/tls.crt"
      sslkey: "/etc/ssl/client-certs/tls.key"
      sslrootcert: "/etc/ssl/client-certs/ca.crt"
    options:
      maxConnections: "25"
      maxIdleConnections: "10"
      connectionMaxLifetime: "1h"
      pollInterval: "5s"
```

### Environment Variables

For environments not using Kubernetes/cert-manager:

```bash
# Required
DATASTORE_PROVIDER=postgresql
DATASTORE_HOST=localhost
DATASTORE_PORT=5432
DATASTORE_DATABASE=nvsentinel
DATASTORE_USERNAME=postgresql

# Certificate-based authentication (recommended)
DATASTORE_SSLMODE=require          # require, verify-ca, verify-full
DATASTORE_SSLCERT=/etc/ssl/client-certs/tls.crt
DATASTORE_SSLKEY=/etc/ssl/client-certs/tls.key
DATASTORE_SSLROOTCERT=/etc/ssl/client-certs/ca.crt
```

### Built-in PostgreSQL Chart

For development and testing, use the built-in PostgreSQL chart:

```yaml
postgresql:
  enabled: true
  architecture: standalone
  auth:
    username: "postgresql"
    database: "nvsentinel"
    # No password required with certificate authentication

  # TLS configuration with cert-manager
  tls:
    enabled: true
    autoGenerated: false
    certificatesSecret: "postgresql-server-cert"
    certFilename: "tls.crt"
    certKeyFilename: "tls.key"
    certCAFilename: "ca.crt"

  # Development-friendly resource limits
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
```

## Database Setup

### 1. Create Database and User for Certificate Authentication

```sql
-- Create database
CREATE DATABASE nvsentinel;

-- Create user with certificate authentication (no password)
CREATE USER postgresql;  -- Username must match certificate CommonName

-- Grant permissions
GRANT ALL PRIVILEGES ON DATABASE nvsentinel TO postgresql;

-- Connect to the nvsentinel database
\c nvsentinel

-- Grant schema permissions
GRANT ALL ON SCHEMA public TO postgresql;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO postgresql;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO postgresql;

-- Grant default privileges for future objects
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO postgresql;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO postgresql;
```

### 2. Configure PostgreSQL for Certificate Authentication

#### Server Configuration

Edit `postgresql.conf`:
```conf
# Enable SSL/TLS
ssl = on
ssl_cert_file = '/var/lib/postgresql/server.crt'
ssl_key_file = '/var/lib/postgresql/server.key'
ssl_ca_file = '/var/lib/postgresql/ca.crt'

# Require client certificates
ssl_crl_file = ''
```

Edit `pg_hba.conf`:
```conf
# Certificate-based authentication
# TYPE  DATABASE        USER        ADDRESS         METHOD
hostssl nvsentinel      postgresql  0.0.0.0/0       cert   clientcert=verify-full
hostssl nvsentinel      postgresql  ::/0            cert   clientcert=verify-full

# Legacy password authentication (if needed for migration)
# hostssl nvsentinel      nvsentinel_user  0.0.0.0/0  md5
```

#### Certificate Management with cert-manager

NVSentinel automatically manages certificates using cert-manager:

```yaml
# Automatic certificate creation
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: postgresql-server-cert
  namespace: nvsentinel
spec:
  secretName: postgresql-server-cert
  issuerRef:
    name: postgresql-ca-issuer
    kind: Issuer
  commonName: nvsentinel-postgresql.nvsentinel.svc.cluster.local
  dnsNames:
  - nvsentinel-postgresql.nvsentinel.svc.cluster.local
  - nvsentinel-postgresql
  - localhost

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: postgresql-client-cert
  namespace: nvsentinel
spec:
  secretName: postgresql-client-cert
  issuerRef:
    name: postgresql-ca-issuer
    kind: Issuer
  commonName: postgresql  # Must match database username
```

### 3. Initialize Schema

The PostgreSQL provider automatically creates the required tables and indexes when it connects. However, you can also run the schema manually:

```bash
# Using certificate authentication
psql "host=localhost port=5432 dbname=nvsentinel user=postgresql sslmode=require sslcert=/etc/ssl/client-certs/tls.crt sslkey=/etc/ssl/client-certs/tls.key sslrootcert=/etc/ssl/client-certs/ca.crt" -f docs/postgresql-schema.sql

# For built-in PostgreSQL in Kubernetes
kubectl exec -it nvsentinel-postgresql-0 -n nvsentinel -- \
  psql -U postgresql -d nvsentinel -f /opt/nvsentinel/postgresql-schema.sql
```

## Architecture

### Tables

1. **maintenance_events**: Stores CSP maintenance events
2. **health_events**: Stores platform health events
3. **datastore_changelog**: Change tracking for change streams
4. **resume_tokens**: Resume position tracking for change streams

### Change Streams

PostgreSQL doesn't have native change streams like MongoDB. The provider implements change streams using:

1. **Triggers**: Automatically log changes to `datastore_changelog` table
2. **Polling**: Background polling for new changes
3. **Resume Tokens**: Track processing position for reliability

### Performance Optimizations

- **JSONB Storage**: Uses JSONB for efficient JSON operations
- **GIN Indexes**: Full-text search on JSON documents
- **Composite Indexes**: Optimized for common query patterns
- **Partial Indexes**: Only index relevant rows (e.g., WHERE conditions)

## Development and Testing

### Development Environment with Tilt

NVSentinel includes a dedicated PostgreSQL development environment:

```bash
# Start PostgreSQL development environment
export TILTFILE=tilt/Tiltfile.postgresql
make dev-env

# Verify PostgreSQL deployment
kubectl get pods -n nvsentinel | grep postgresql
kubectl logs -l app.kubernetes.io/name=postgresql -n nvsentinel

# Check certificate configuration
kubectl get certificates -n nvsentinel
kubectl describe certificate postgresql-client-cert -n nvsentinel
```

### E2E Testing

The CI/CD pipeline includes comprehensive PostgreSQL testing across multiple architectures:

```yaml
# E2E Test Matrix (from .github/workflows/e2e-test.yml)
strategy:
  matrix:
    include:
      - arch: amd64
        datastore: "postgresql"
        datastore_name: "PostgreSQL"
      - arch: arm64
        datastore: "postgresql"
        datastore_name: "PostgreSQL"
```

### Local Testing

Run PostgreSQL E2E tests locally:

```bash
# Set up unique cluster for testing
export CLUSTER_NAME_SUFFIX="-test-postgresql"
export TILTFILE=tilt/Tiltfile.postgresql

# Run full E2E test suite
make e2e-test-ci

# Or run individual steps
make cluster-create
make tilt-ci
make -C tests test-ci
```

### Validation Script

Use the enhanced validation script to check PostgreSQL deployments:

```bash
# Auto-detects PostgreSQL and validates configuration
./scripts/validate-nvsentinel.sh

# Output includes:
# ✓ PostgreSQL datastore detected
# ✓ Certificate authentication configured
# ✓ All pods ready and healthy
# ✓ Database connectivity verified
# ✓ No recent restart activity
```

## Migration from MongoDB

### Prerequisites

1. **Backup existing MongoDB data**
2. **Prepare PostgreSQL instance with certificate authentication**
3. **Plan maintenance window for migration**

### Migration Steps

1. **Export MongoDB Data**: Use `mongoexport` or custom scripts
   ```bash
   mongoexport --host mongodb-host:27017 --db nvsentinel --collection health_events --out health_events.json
   mongoexport --host mongodb-host:27017 --db nvsentinel --collection maintenance_events --out maintenance_events.json
   ```

2. **Transform Data**: Convert BSON to JSON format compatible with PostgreSQL JSONB
   ```bash
   # Custom script to transform ObjectId and other BSON types
   python3 scripts/mongodb-to-postgresql-converter.py health_events.json
   ```

3. **Import to PostgreSQL**: Use `COPY` or `INSERT` statements
   ```sql
   -- Import health events
   COPY health_events(data) FROM '/path/to/health_events_transformed.json';

   -- Import maintenance events
   COPY maintenance_events(data) FROM '/path/to/maintenance_events_transformed.json';
   ```

4. **Update Configuration**: Switch from MongoDB to PostgreSQL
   ```bash
   # Update Helm values or environment variables
   export DATASTORE_PROVIDER=postgresql
   # Remove MongoDB configuration
   # Add PostgreSQL certificate configuration
   ```

5. **Deploy and Verify**: Update NVSentinel deployment
   ```bash
   helm upgrade nvsentinel ./distros/kubernetes/nvsentinel \
     -f values-postgresql.yaml

   # Verify migration
   ./scripts/validate-nvsentinel.sh
   ```

### Migration Verification

```sql
-- Compare record counts
SELECT 'health_events' as table_name, COUNT(*) as count FROM health_events
UNION ALL
SELECT 'maintenance_events' as table_name, COUNT(*) as count FROM maintenance_events;

-- Verify data integrity
SELECT data->>'id', data->>'timestamp' FROM health_events LIMIT 5;
```

## Monitoring

### Key Metrics

Monitor these PostgreSQL metrics:

- Connection pool usage
- Query execution time
- Change stream lag
- Table sizes and growth
- Index usage

### Useful Queries

```sql
-- Check connection pool status
SELECT * FROM pg_stat_activity WHERE datname = 'nvsentinel';

-- Monitor change stream lag
SELECT
  table_name,
  COUNT(*) as pending_changes,
  MAX(changed_at) as latest_change
FROM datastore_changelog
WHERE processed = FALSE
GROUP BY table_name;

-- Table sizes
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## Troubleshooting

### Common Issues

1. **Certificate Authentication Failures**
   ```bash
   # Check certificate mounting
   kubectl exec -it deployment/nvsentinel-platform-connector -n nvsentinel -- \
     ls -la /etc/ssl/client-certs/

   # Verify certificate validity
   kubectl exec -it deployment/nvsentinel-platform-connector -n nvsentinel -- \
     openssl x509 -in /etc/ssl/client-certs/tls.crt -text -noout

   # Check certificate permissions
   kubectl exec -it deployment/nvsentinel-platform-connector -n nvsentinel -- \
     stat /etc/ssl/client-certs/tls.key
   ```

2. **Connection Failures**
   - Check host, port, and SSL configuration
   - Verify PostgreSQL is running and accessible
   - Check certificate configuration and Subject Alternative Names
   - Ensure proper network policies and firewall rules

3. **Permission Errors**
   - Ensure user has necessary database privileges
   - Check schema and table permissions
   - Verify certificate CommonName matches database username

4. **Performance Issues**
   - Monitor index usage with `pg_stat_user_indexes`
   - Check query plans with `EXPLAIN ANALYZE`
   - Consider increasing connection pool size
   - Monitor certificate validation overhead

5. **Change Stream Lag**
   - Monitor `datastore_changelog` table size
   - Adjust `pollInterval` configuration
   - Clean up old processed changelog entries
   - Check database connectivity and performance

### Certificate Debugging

```bash
# Check cert-manager certificate status
kubectl get certificates -n nvsentinel
kubectl describe certificate postgresql-client-cert -n nvsentinel

# Check certificate issuer
kubectl get issuer -n nvsentinel
kubectl describe issuer postgresql-ca-issuer -n nvsentinel

# Debug certificate renewal
kubectl get certificaterequests -n nvsentinel
kubectl logs -l app=cert-manager -n cert-manager
```

### Debugging

Enable detailed logging:

```bash
# Enable verbose logging for NVSentinel components
kubectl set env deployment/nvsentinel-platform-connector KLOG_V=2 -n nvsentinel
kubectl set env deployment/nvsentinel-fault-quarantine KLOG_V=2 -n nvsentinel

# Check PostgreSQL logs
kubectl logs nvsentinel-postgresql-0 -n nvsentinel

# External PostgreSQL logs
tail -f /var/log/postgresql/postgresql-*.log
```

### Performance Debugging

```sql
-- Check certificate authentication activity
SELECT * FROM pg_stat_ssl WHERE pid IN (
    SELECT pid FROM pg_stat_activity WHERE datname = 'nvsentinel'
);

-- Monitor connection SSL status
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    ssl,
    ssl_version,
    ssl_cipher
FROM pg_stat_activity
WHERE datname = 'nvsentinel';
```

## Best Practices

### Security

1. **Certificate Authentication**: Always use certificate-based authentication in production
2. **Certificate Rotation**: Leverage cert-manager for automatic certificate renewal
3. **SSL/TLS**: Use `sslmode=verify-full` for maximum security
4. **Network Security**: Implement proper network policies and firewall rules
5. **Privilege Management**: Use principle of least privilege for database users

### Performance

1. **Connection Pooling**: Use appropriate pool sizes based on workload
2. **Certificate Caching**: Monitor certificate validation overhead
3. **Index Optimization**: Regular monitoring and optimization of query performance
4. **Resource Limits**: Set appropriate CPU and memory limits for PostgreSQL pods

### Operations

1. **Monitoring**: Set up comprehensive monitoring for certificates, connections, and performance
2. **Backups**: Regular database backups with point-in-time recovery
3. **Maintenance**: Regular `VACUUM` and `ANALYZE` operations
4. **Changelog Cleanup**: Periodically clean old changelog entries
5. **Certificate Monitoring**: Monitor certificate expiration and renewal

### Development

1. **Tilt Integration**: Use `tilt/Tiltfile.postgresql` for development environments
2. **E2E Testing**: Leverage the comprehensive E2E test matrix
3. **Validation Scripts**: Use `./scripts/validate-nvsentinel.sh` for deployment verification
4. **Multi-Architecture**: Test on both AMD64 and ARM64 architectures

## Limitations

1. **Change Streams**: Polling-based implementation (not real-time like MongoDB)
2. **Transactions**: Some complex operations may need transaction tuning
3. **Scaling**: Primarily vertical scaling (horizontal scaling requires PostgreSQL clustering)
4. **Certificate Overhead**: Slight performance impact from certificate validation
5. **cert-manager Dependency**: Requires cert-manager for automatic certificate management

## Architecture Considerations

### Production Deployment

```yaml
# High-availability PostgreSQL configuration
postgresql:
  enabled: false  # Use external PostgreSQL cluster

global:
  datastore:
    provider: "postgresql"
    connection:
      host: "postgresql-ha-cluster.production.internal"
      port: 5432
      database: "nvsentinel"
      username: "postgresql"
      sslmode: "verify-full"
      sslcert: "/etc/ssl/client-certs/tls.crt"
      sslkey: "/etc/ssl/client-certs/tls.key"
      sslrootcert: "/etc/ssl/client-certs/ca.crt"
    options:
      maxConnections: "50"  # Scale based on workload
      maxIdleConnections: "20"
      connectionMaxLifetime: "30m"
      pollInterval: "3s"
```

### Multi-Cluster Deployment

For multi-cluster deployments, consider:

1. **Certificate Management**: Ensure consistent CA across clusters
2. **Database Replication**: Use PostgreSQL streaming replication
3. **Network Connectivity**: Secure inter-cluster networking
4. **Monitoring**: Centralized monitoring across all clusters

## Support

### Issue Resolution Process

1. **Check Deployment Status**: Use validation script first
   ```bash
   ./scripts/validate-nvsentinel.sh
   ```

2. **Certificate Issues**: Verify cert-manager and certificate status
   ```bash
   kubectl get certificates -n nvsentinel
   kubectl describe certificate postgresql-client-cert -n nvsentinel
   ```

3. **Connection Issues**: Test database connectivity
   ```bash
   kubectl exec -it nvsentinel-postgresql-0 -n nvsentinel -- \
     psql -U postgresql -d nvsentinel -c "SELECT version();"
   ```

4. **Performance Issues**: Monitor PostgreSQL metrics
   ```sql
   SELECT * FROM pg_stat_activity WHERE datname = 'nvsentinel';
   SELECT * FROM pg_stat_ssl;
   ```

5. **Log Analysis**: Check application and database logs
   ```bash
   kubectl logs -l app.kubernetes.io/name=platform-connectors -n nvsentinel
   kubectl logs nvsentinel-postgresql-0 -n nvsentinel
   ```

For complex issues, provide:
- Validation script output
- Certificate status and configuration
- Application and database logs
- PostgreSQL configuration and version
- Network configuration and policies